---
title: "Same variable in fixed and random effects"
description: "Learn what the effect is of having the same variable in the fixed and random part of a mixed model."
authors: [thierryo]
date: "`r Sys.Date()`"
categories: ["r", "statistics"]
tags: ["r", "analysis", "mixed model"]
output: 
    md_document:
        preserve_yaml: true
        variant: gfm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Used packages

```{r}
library(ggplot2)
library(lme4)
```

## Dummy data

For the sake of this demontration we use a very simple dataset with a very high signal versus noise ratio. 
Let's look at a simple timeseries with multiple observations per timepoint.

```{r generate_data}
set.seed(213354)
n.year <- 30
n.replicate <- 10
sd.noise <- 0.1
dataset <- expand.grid(
  Replicate =  seq_len(n.replicate),
  Year = seq_len(n.year)
)
dataset$fYear <- factor(dataset$Year)
dataset$Noise <- rnorm(nrow(dataset), mean = 0, sd = sd.noise)
dataset$Linear <- 1 + 2 * dataset$Year + dataset$Noise
dataset$Quadratic <- 1 + 20 * dataset$Year - 0.5 * dataset$Year ^ 2 + 
  dataset$Noise
```


```{r linear}
ggplot(dataset, aes(x = Year, y = Linear)) + geom_point()
```


```{r quadratic}
ggplot(dataset, aes(x = Year, y = Quadratic)) + geom_point()
```


## Quadratic trend but fit as a linear trend

Assume that we assume that the trend is linear but in reality it is quadratic. 
In this case the random intercept of year will pickup the differences with the linear trend.

```{r}
model.quadratric <- lmer(Quadratic ~ Year + (1|Year), 
                         data = dataset)
summary(model.quadratric)
```


```{r}
dataset$QuadraticPredict <- predict(model.quadratric)
dataset$QuadraticFixed <- predict(model.quadratric, re.form = ~0)
```


```{r}
ggplot(dataset, aes(x = Year, y = Quadratic)) + 
  geom_point() + 
  geom_line(aes(y = QuadraticFixed), colour = "red") + 
  geom_line(aes(y = QuadraticPredict), colour = "blue")
```


The random effects will have a strong pattern. 
Indicating that a second order polynomial makes more sense than a linear trend.

```{r}
rf <- data.frame(
  Year = seq_len(n.year),
  RandomIntercept = ranef(model.quadratric)$Year[, 1]
)
```


```{r}
ggplot(rf, aes(x = Year, y = RandomIntercept)) + 
  geom_point()
```

## What if the trend is perfectly linear?

Both the fixed effect and the random effect can perfectly model the pattern in the data. 
So the model seems to be unidentifiable. 
However the likelihood of the model contains a penalty term for the random intercept. 
The stronger the absolute value of the random effect, the stronger the penalty. 
The fixed effects have no penalty term. 
Hence, model with strong fixed effect will have a higher likelihood than exactly the same fit generated by strong random effects.

In this case the linear trend is very strong compared to the noise. 
So the linear trend in the fixed effect fits the data very well. 
Note that the random effect variance is zero.

```{r}
model.linear <- lmer(Linear ~ Year + (1|Year), data = dataset)
summary(model.linear)
dataset$LinearPredict <- predict(model.linear)
dataset$LinearFixed <- predict(model.linear, re.form = ~0)
```


```{r}
ggplot(dataset, aes(x = Year, y = Linear)) + 
  geom_point() + 
  geom_line(aes(y = LinearFixed), colour = "red") + 
  geom_line(aes(y = LinearPredict), colour = "blue")
```

## What about fitting year as a factor in the fixed effects

Combining the same variables as a factor in the fixed effects and as a random intercept doesn't make sense. 
They allow exactly the same model fit and thus the random intercept will always shrink to zero.
